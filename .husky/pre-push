#!/usr/bin/env bash

set -euo pipefail

log_buffer="$(mktemp -t kingdom-verify.XXXXXX)"
trap 'rm -f "$log_buffer"' EXIT

if npm run verify 2>&1 | tee "$log_buffer"; then
  exit 0
fi

verify_status=${PIPESTATUS[0]}

environment_error_pattern='ENOENT|ERR_MODULE_NOT_FOUND|Cannot find module'
environment_error_pattern+='|Missing script: verify'
environment_error_pattern+='|is not recognized as an internal or external command'

if grep -Eq "$environment_error_pattern" "$log_buffer"; then
  echo "npm run verify is unavailable in this environment; falling back to" >&2
  echo "direct npm run check && npm run test:coverage." >&2
  npm run check
  npm run test:coverage
  exit 0
fi

exit "$verify_status"
