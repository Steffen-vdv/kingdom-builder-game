#!/usr/bin/env sh
# Pre-push hook - auto-formats, commits if needed, and runs quality checks

set -e

# Auto-fix formatting
npm run format

# If format changed files, commit and push them, then abort original push
if ! git diff --quiet; then
    echo ""
    echo "üìù Formatting changed files - auto-committing..."
    git add -A
    git commit -m "chore: auto-format"

    # Run type checking and linting in parallel
    npx run-p typecheck lint

    echo ""
    echo "‚úÖ Pushing with auto-format commit..."
    git push --no-verify

    # Exit 1 to abort the original push (we already pushed successfully)
    # This prevents git from trying to push stale refs
    exit 1
fi

# No formatting needed - just run checks and let original push proceed
npx run-p typecheck lint
