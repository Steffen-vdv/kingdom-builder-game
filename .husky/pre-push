#!/usr/bin/env sh
# Pre-push hook - auto-formats, commits if needed, and runs quality checks

set -e

# Auto-fix formatting
npm run format

# Track if we created an auto-format commit
AUTO_FORMATTED=false

# If format changed files, commit them
if ! git diff --quiet; then
    echo ""
    echo "üìù Formatting changed files - auto-committing..."
    git add -A
    git commit -m "chore: auto-format"
    AUTO_FORMATTED=true
fi

# Run type checking first (posttypecheck cleans dist), then lint
# Can't parallelize due to race condition with dist files
npm run typecheck
npm run lint

# Safety check: verify formatting is clean after all other scripts ran
# This catches edge cases where typecheck/lint scripts might touch files
npm run format:check

# If we created an auto-format commit, push it now (skip hooks - we just validated)
if [ "$AUTO_FORMATTED" = true ]; then
    echo ""
    echo "‚úÖ Pushing auto-format commit..."
    git push --no-verify
fi
