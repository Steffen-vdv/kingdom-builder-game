# Resource Migration Project – Production Document (ARCHIVED)

> **ARCHIVED**: This document is locked and no longer accepting updates.
> The Resource Migration project has concluded its active development phase.

## 1. Quick Context

- **Project Name:** Resource Migration (ResourceV2 unification)
- **Goal:** Replace legacy resource/stat/population systems with the unified ResourceV2 platform across engine, content, protocol, and web.
- **Final Phase:** Engine integration & enforcement complete – runtime catalog data, global costs, and population flows integrated into ResourceV2.

## 2. High-Level Status Snapshot

| Area         | Current State                 | Owner | Notes                                                                                                                                                                                           |
| ------------ | ----------------------------- | ----- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Engine       | Migrated (runtime ready)      | –     | Runtime catalog, player state/setup, services, AI, and logging now operate on ResourceV2 (T38–T48). Full-suite check proceeds after T59.5 resolved the contents `developmentTarget` regression. |
| Content      | MVP scope complete            | –     | Catalog, start payloads, actions, passives, and phases emit ResourceV2 payloads end to end (T18–T36).                                                                                           |
| Protocol/API | Transport-aligned             | –     | Session contracts document ResourceV2 registries/values and transports now mirror the catalogs across gateway responses; flip optional flags once data is emitted by default.                   |
| Web UI       | Migrated (awaiting live data) | –     | Translation context, player UI, and diff helpers now consume ResourceV2 metadata end-to-end; final HUD verification depends on transports surfacing signed deltas in sessions.                  |
| Testing      | Updated (passing)             | –     | Integration, unit, and web suites assert ResourceV2 builders/catalogs, and `npm run check` now passes after the `developmentTarget` helper fix in T59.5.                                        |

## 3. Work Log (Historical)

| Date       | Agent                             | Scope / Files                                                                                                                                                                                                | Summary of Work                                                                                                                                                                           | Tests & Results                                                                          | Follow-up Actions                                                                                                                                          |
| ---------- | --------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 2025-10-22 | ChatGPT (gpt-5-codex)             | packages/contents/src/resourceV2/types.ts, packages/contents/src/resourceV2/index.ts                                                                                                                         | Resource Migration MVP - P2 - T1 - Added ResourceV2 schema type scaffolding and documented follow-ups.                                                                                    | _Not run (types only)_                                                                   | Confirm schema assumptions for tier metadata and group parent scope.                                                                                       |
| 2025-10-23 | ChatGPT (gpt-5-codex)             | packages/contents/src/resourceV2/resourceBuilder.ts, packages/contents/src/resourceV2/index.ts                                                                                                               | Resource Migration MVP - P2 - T2 - Implemented chainable ResourceV2 builder with validation, exported API, and captured next steps for registry helpers.                                  | _Not run (builder scaffolding)_                                                          | Draft registry helper adapters to adopt the builder in upcoming tasks.                                                                                     |
| 2025-10-24 | ChatGPT (gpt-5-codex)             | packages/contents/src/resourceV2/groupBuilder.ts, packages/contents/src/resourceV2/registry.ts, packages/contents/src/resourceV2/index.ts, packages/contents/src/index.ts                                    | Resource Migration MVP - P2 - T3 - Added ResourceV2 group builder and registry helpers with duplicate validation, exported APIs, and documented rollout.                                  | npm run format; npm run lint; npm run check                                              | Coordinate adoption of registry helpers in content packages and plan first migrated resource entry.                                                        |
| 2025-10-25 | ChatGPT (gpt-5-codex)             | packages/protocol/src/resource-v2/types.ts, packages/protocol/src/resource-v2/index.ts, packages/protocol/src/index.ts                                                                                       | Resource Migration MVP - P2 - T12 - Added ResourceV2 protocol payload types and exported them for downstream consumers, keeping parity with runtime schema.                               | npm run format; npm run lint; npm run check                                              | Extend session contracts to surface ResourceV2 registries and payload structures.                                                                          |
| 2025-10-25 | ChatGPT (gpt-5-codex)             | packages/contents/tests/resourceV2/resourceV2Builders.test.ts                                                                                                                                                | Resource Migration MVP - P2 - T4 - Added ResourceV2 builder and group registry tests covering happy paths, duplicate setters, bounds validation, and cost safeguards.                     | npm run test --workspace @kingdom-builder/contents (pass)                                | Audit bounds() helper interactions with pre-set limits and validate multi-resource global cost authoring scenarios.                                        |
| 2025-10-25 | ChatGPT (gpt-5-codex)             | packages/engine/src/resource-v2/types.ts, packages/engine/src/resource-v2/content-types.ts, packages/engine/src/resource-v2/fromContent.ts, packages/engine/src/resource-v2/index.ts                         | Resource Migration MVP - P2 - T5 - Added runtime ResourceV2 catalog types, converter with MVP validation/defaulting, and documented pending integration tasks.                            | npm run format; npm run lint; npm run check                                              | Wire runtime catalog into engine bootstrap, finish converter tests, and confirm check pipeline in follow-up tasks.                                         |
| 2025-10-25 | ChatGPT (gpt-5-codex)             | packages/testing/src/factories/resourceV2.ts, packages/testing/src/index.ts                                                                                                                                  | Resource Migration MVP - P2 - T14 - Introduced ResourceV2 testing factories wrapping builders with override support and registry materialisers.                                           | npm run format; npm run lint; npm run check                                              | Integrate helpers into engine/protocol suites and expand coverage once first migrated resource lands.                                                      |
| 2025-10-26 | ChatGPT (gpt-5-codex)             | packages/protocol/src/session/contracts.ts, packages/protocol/src/session/index.ts                                                                                                                           | Resource Migration MVP - P2 - T13 - Added optional ResourceV2 session contract fields (registries, player valuesV2, metadata mirrors) and documented their placeholder status.            | npm run format; npm run lint; npm run check (partial)                                    | Wire server/session transports to populate the new ResourceV2 fields and rerun full check once wiring lands.                                               |
| 2025-10-26 | ChatGPT (gpt-5-codex)             | packages/engine/src/state/index.ts, packages/engine/src/actions/context_clone.ts                                                                                                                             | Resource Migration MVP - P2 - T6 - Added PlayerState scaffolding for ResourceV2 values, bounds, tier tracking, and touched flags while keeping legacy Resource/Stat wiring intact.        | npm run format; npm run lint; npm run check                                              | Plan follow-up wiring to seed ResourceV2 maps from runtime registries and surface them in snapshots once live data hooks in.                               |
| 2025-10-26 | ChatGPT (gpt-5-codex)             | packages/engine/src/resource-v2/reconciliation.ts, packages/engine/src/resource-v2/index.ts                                                                                                                  | Resource Migration MVP - P2 - T8 - Added reconciliation utilities that compute static/percent deltas with configurable rounding, clamp against bounds, export shared types.               | npm run format; npm run lint; npm run check                                              | Wire helpers into resource effect handlers and author targeted rounding/clamp unit tests.                                                                  |
| 2025-10-26 | ChatGPT (gpt-5-codex)             | packages/web/src/translation/resourceV2/formatters.ts, packages/web/src/translation/resourceV2/index.ts, packages/web/src/translation/index.ts, packages/web/tests/translation/resourceV2/formatters.test.ts | Resource Migration MVP - P2 - T15 - Added ResourceV2 translation helpers that turn metadata/value snapshots into summaries, hover sections, and Option A signed gain entries.             | npm run format; npm run lint; npm run check                                              | Wire helpers into the web UI once ResourceV2 values surface in session snapshots and log wiring begins.                                                    |
| 2025-10-27 | ChatGPT (gpt-5-codex)             | packages/engine/tests/resource-v2/state-helpers.test.ts, packages/engine/tests/resource-v2/effects-handlers.test.ts                                                                                          | Resource Migration MVP - P2 - T11 - Authored ResourceV2 state helper and handler tests covering clamp rounding, tier tracking, touched/bound flags, signed logging, and transfer options. | npx vitest run --config vitest.engine.config.ts packages/engine/tests/resource-v2 (pass) | Backfill tier-transition coverage for mixed transfers and parent bound changes once runtime catalog wiring reaches the engine context.                     |
| 2025-10-27 | ChatGPT (gpt-5-codex)             | packages/contents/src/resourceV2/definitions/stats.ts, packages/contents/src/resourceV2/definitions/population.ts, packages/contents/src/resourceV2/catalog.ts                                               | Resource Migration MVP - P2 - T20–T22 - Authored stat and population ResourceV2 definitions plus shared catalog registries.                                                               | _Not run – content definitions/catalog updates only_                                     | Thread registries into engine/bootstrap surfaces and confirm downstream consumers resolve ResourceV2 ids.                                                  |
| 2025-10-27 | ChatGPT (gpt-5-codex)             | packages/contents/src/resources.ts, packages/contents/src/stats.ts, packages/contents/src/happinessHelpers.ts                                                                                                | Resource Migration MVP - P2 - T23–T24 - Bridged legacy exports onto ResourceV2 registries and aligned rules metadata.                                                                     | _Not run – bridge/rules alignment pending engine adoption_                               | Migrate remaining content helpers to ResourceV2 metadata and retire manual formatting overrides.                                                           |
| 2025-10-27 | ChatGPT (gpt-5-codex)             | packages/protocol/src/config/schema.ts, packages/contents/src/config/builders/startConfig/playerStartBuilder.ts, packages/contents/src/game.ts                                                               | Resource Migration MVP - P2 - T25–T27 - Extended protocol schemas, start builders, and start payloads with ResourceV2 values/bounds.                                                      | _Not run – schema/start payload scaffolding only_                                        | Wire the new start maps through engine/session transports and validate mirrored values once check pipeline stabilises.                                     |
| 2025-10-28 | ChatGPT (gpt-5-codex)             | packages/contents/src/resourceV2/effects/changeBuilder.ts, packages/contents/src/resourceV2/effects/transferBuilder.ts, packages/contents/src/config/builders/effectParams/resourceParams.ts                 | Resource Migration MVP - P2 - T28–T31 - Introduced ResourceV2 change/transfer builders and wrapped legacy parameter helpers around them.                                                  | _Not run – ResourceV2 builder migrations awaiting engine adoption_                       | Execute contents and engine suites once handlers consume the new payloads to validate reconciliation paths.                                                |
| 2025-10-28 | ChatGPT (gpt-5-codex)             | packages/contents/src/actions/basicActions.ts, packages/contents/src/actions/buildActions.ts, packages/contents/src/actions/hireActions.ts, packages/contents/src/buildings.ts                               | Resource Migration MVP - P2 - T32–T36 - Converted core actions, passives, and phase hooks to ResourceV2 payloads.                                                                         | npm run format; npm run lint; npm run check _(fails: known developmentTarget TypeError)_ | Coordinate with engine handlers to consume the new payloads and unblock the failing repository check stage.                                                |
| 2025-10-28 | ChatGPT (gpt-5-codex)             | docs/project/resource-migration/production/production-living-docs.md                                                                                                                                         | Resource Migration MVP - P2 - T37 - Aggregated content migration progress and outstanding engine questions.                                                                               | _Not run – documentation aggregation only_                                               | Resolve listed engineering questions and update the living doc as decisions land.                                                                          |
| 2025-10-29 | ChatGPT (gpt-5-codex)             | packages/engine/src/setup/create\*engine.ts, packages/engine/src/state/index.ts, packages/protocol/src/session/resourceCatalogV2.ts                                                                          | Resource Migration MVP - P2 - T38–T40 - Wired the runtime catalog through engine bootstrap, player state proxies, and start overrides.                                                    | npm run format; npm run lint; npm run check _(fails: developmentTarget TypeError)_       | Stabilise `developmentTarget` helper and expand engine tests around the new ResourceV2 bootstrap path.                                                     |
| 2025-10-29 | ChatGPT (gpt-5-codex)             | packages/engine/src/actions/costs.ts, packages/engine/src/effects/index.ts, packages/engine/src/effects/population_add.ts                                                                                    | Resource Migration MVP - P2 - T41–T43 - Enforced catalog-driven global costs, re-registered ResourceV2 handlers, and synced population effects.                                           | npm run format; npm run lint; npm run check _(fails: developmentTarget TypeError)_       | Remove legacy cost/population shims once `developmentTarget` regression is fixed and ResourceV2 payloads are fully enforced.                               |
| 2025-11-01 | ChatGPT (gpt-5-codex)             | docs/project/resource-migration/production/production-living-docs.md                                                                                                                                         | Resource Migration MVP - P2 - T58 - Consolidated T50–T57 protocol, transport, web, and test updates into the living doc and flagged final-phase cleanup priorities.                       | _Not run – documentation aggregation only_                                               | Resolve `developmentTarget` failure, default ResourceV2 session fields before flipping to required, and smoke-test HUD once transports emit signed deltas. |
| 2025-11-02 | ChatGPT (gpt-5-codex)             | packages/protocol/src/session/_, packages/engine/src/runtime/_, packages/web/src/translation/\*_/_, tests/\*                                                                                                 | Resource Migration MVP - P2 - T62 - Required ResourceV2 session payloads enforced across protocol, engine transports, translation context, and tests.                                     | npm run format; npm run lint; npm run check                                              | Monitor downstream consumers for lingering optional ResourceV2 assumptions.                                                                                |
| 2025-11-02 | ChatGPT (gpt-5-codex)             | packages/contents/src/config/builders/advancedEffectParams.ts, packages/contents/src/happinessHelpers.ts, packages/contents/tests/happinessHelpers.test.ts                                                   | Resource Migration MVP - P2 - T59.5 - Restored developmentTarget factory, refreshed happiness helpers/tests, and documented the regression fix.                                           | npm run test --workspace @kingdom-builder/contents; npm run check                        | Monitor downstream packages for any cached builder usage that might need the refreshed factory.                                                            |
| 2025-12-07 | Claude (claude-opus-4-5-20251101) | packages/web/src/translation/log/resourceSources/meta.ts, packages/web/src/utils/stats/descriptorRegistry.ts, packages/web/tests/\*                                                                          | Resource Migration MVP - T68 - Migrated test files and fixtures to unified ResourceV2 patterns; removed legacy population/stat descriptors; renamed test files.                           | npm run check; npm run test:quick (all 916 tests pass)                                   | Rename `packages/web/src/utils/stats/` folder; consolidate evaluators.                                                                                     |

## 4. Final Handover

- **Prepared by:** Claude (claude-opus-4-5-20251101)
- **Timestamp (UTC):** 2025-12-07 13:00
- **Final Focus:** Resource Migration MVP - T68 - Test pattern migration
- **State Summary:**
  - Migrated test files and fixtures to use unified ResourceV2 patterns.
  - Removed legacy `population` and `stat` descriptors from descriptor registry.
  - Updated meta source icon renderer to use `type: 'resource'` instead of
    `type: 'population'`.
  - Renamed test files to reflect ResourceV2 paradigm:
    - `stat-descriptor-registry.test.ts` → `resource-source-descriptors.test.ts`
    - `stat-breakdown.test.ts` → `resource-breakdown.test.ts`
  - All 916 tests pass across all packages.
- **Suggested Future Work:**
  - Rename `packages/web/src/utils/stats/` folder since it no longer contains
    stat-specific utilities.
  - Continue removing legacy terminology from remaining source files.
  - Consolidate stat/population/resource evaluators into unified evaluator.
- **Blocking Issues / Risks:** None.

## 5. Notes & Decisions Archive

### 2024-**-** – Initial scaffolding

- Recommended first migration target: **Absorption** (selected for its limited integrations and low risk while still covering stat-specific behaviours).

### 2024-**-** – MVP scope alignment

- MVP delivery is limited to clamp-based reconciliation, parented ResourceGroups, mandatory add/remove/transfer/upper-bound increase effects, percent modifiers, the hook-suppression escape hatch, a single global action cost resource, unified HUD/translations, and signed gain/loss logging (Option A). All other features stay on the backlog for later phases.
- Deferred items (value/bound breakdown capture, additional bound adjusters, Pass/Reject reconciliation, parentless groups, bound-decrease effects, comprehensive validators, tier-based shortfall replacement, extra global cost resources) are tracked in [Deferred (Post-MVP) Work](../pre-production/project-outline.md#5-deferred-post-mvp-work). Do not reintroduce these during daily task triage.
- Phase summaries must log both gains and losses in `recentResourceGains` (Option A) so stakeholders can audit negative swings without waiting for the backlog enhancements.

## 6. Intended Temporary Regressions

| Description | Introduced In | Expected Resolution | Status |
| ----------- | ------------- | ------------------- | ------ |
| _(none)_    | –             | –                   | –      |

## 7. Completed Follow-ups

| Item                                                                            | Owner | Due / Trigger                                            | Status       |
| ------------------------------------------------------------------------------- | ----- | -------------------------------------------------------- | ------------ |
| Repair `developmentTarget` helper to unblock `npm run check`.                   | –     | Before final phase sign-off                              | Done (T59.5) |
| Default ResourceV2 session fields and flip protocol optional flags to required. | –     | Completed via T62                                        | Done         |
| Run HUD/translation smoke tests with live ResourceV2 deltas.                    | –     | Once transports surface signed deltas and group metadata | Pending      |

## 8. Reference

- [Pre-production documentation](../pre-production/)
