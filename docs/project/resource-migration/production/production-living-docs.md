# Resource Migration Project – Production Living Document

This document captures the evolving state of the Resource Migration initiative. Every agent **must** read the entire file before making changes and must append their own update when finishing a task.

## 1. Quick Context

- **Project Name:** Resource Migration (ResourceV2 unification)
- **Goal:** Replace legacy resource/stat/population systems with the unified ResourceV2 platform across engine, content, protocol, and web.
- **Current Phase:** Planning bootstrap – documentation and project scaffolding.

## 2. High-Level Status Snapshot

| Area         | Current State | Owner | Notes                                                                          |
| ------------ | ------------- | ----- | ------------------------------------------------------------------------------ |
| Engine       | In progress   | –     | ResourceV2 service + handler scaffolding implemented; registry wiring pending. |
| Content      | _TBD_         | –     | Legacy systems intact.                                                         |
| Protocol/API | _TBD_         | –     | Awaiting design sign-off.                                                      |
| Web UI       | _TBD_         | –     | Pending migration strategy.                                                    |
| Testing      | _TBD_         | –     | Unified test plan not started.                                                 |

Update the table whenever a domain meaningfully changes. Keep comments concise and reference sections below for detail.

## 3. Work Log (append-only)

| Date                                                                                                                                                                                                | Agent                                         | Scope / Files                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | Summary of Work                                                                                                                                                                                                                                     | Tests & Results                                                                                                                                                                                                       | Follow-up Actions                                                                                                                                                           |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 2025-10-22                                                                                                                                                                                          | ChatGPT (gpt-5-codex)                         | packages/protocol/src/config/resourceV2.ts; packages/protocol/src/config/schema.ts; packages/protocol/tests/resourceV2-schema.test.ts; docs/project/resource-migration/production/production-living-docs.md                                                                                                                                                                                                                                                                             | Added ResourceV2 schema/module exports plus validation tests for ResourceV2 payloads.                                                                                                                                                               | `npx tsc -p packages/protocol/tsconfig.json --pretty false` (pass); `npx vitest run --config vitest.protocol.config.ts` (pass)                                                                                        | Draft protocol payload integration plan building on new schema artifacts.                                                                                                   |
| 2025-10-22                                                                                                                                                                                          | ChatGPT (gpt-5-codex)                         | packages/protocol/src/effects.ts; packages/protocol/src/config/effect_schemas.ts; packages/protocol/tests/config-schema.test.ts; docs/project/resource-migration/production/production-living-docs.md                                                                                                                                                                                                                                                                                   | Added effect metadata fields (rounding, reconciliation, hook suppression) plus schema validation and regression coverage.                                                                                                                           | `npx tsc -p packages/protocol/tsconfig.json --pretty false` (pass); `npx vitest run --config vitest.protocol.config.ts` (pass); `npm run check -- --filter protocol` (fails: npm-run-all does not support `--filter`) | Align check workflow to support protocol-only runs or update task instructions.                                                                                             |
| 2025-10-22                                                                                                                                                                                          | ChatGPT (gpt-5-codex)                         | packages/contents/src/config/builders/resourceV2Builder.ts; packages/contents/src/config/builders.ts; packages/contents/src/config/builders/domain/index.ts; packages/contents/src/config/builders/**tests**/resourceV2Builder.test.ts; docs/project/resource-migration/production/production-living-docs.md                                                                                                                                                                            | Implemented ResourceV2 builders (definition, tier track, ResourceGroup) with guardrails, exports, and regression coverage; refreshed production log guidance.                                                                                       | `npm run check -- --filter contents` (fails: npm-run-all rejects `--filter`); `npm run check`                                                                                                                         | Next content tasks should add ResourceV2 effect builders and pilot the Absorption migration.                                                                                |
| 2025-10-23                                                                                                                                                                                          | ChatGPT (gpt-5-codex)                         | packages/contents/src/resourceV2/index.ts; packages/contents/src/index.ts; packages/contents/tests/resourceV2-registry.test.ts; docs/project/resource-migration/production/production-living-docs.md                                                                                                                                                                                                                                                                                    | Built ResourceV2 and ResourceGroup registries from the new builders, exported factory helpers, and added regression coverage for ordering, immutability, and parent/child constraints.                                                              | `npm run format`; `npm run lint`; `npm run check`                                                                                                                                                                     | Coordinate with engine and web owners to adopt the registries and expand ResourceV2 definitions (population roles, tier data) ahead of migration.                           |
| 2025-10-22                                                                                                                                                                                          | ChatGPT (gpt-5-codex)                         | packages/testing/src/factories/content.ts; packages/testing/src/factories/resourceV2.ts; packages/testing/tests/content-factory-resourceV2.test.ts; docs/project/resource-migration/production/production-living-docs.md                                                                                                                                                                                                                                                                | Added ResourceV2 factory helpers to testing content factory, ensured type re-exports for compatibility, and introduced focused ResourceV2 bounds/tier/order tests.                                                                                  | `npm run lint` (pass); `npm run check` (pass)                                                                                                                                                                         | Monitor downstream test factories for ResourceV2 adoption needs and extend helper coverage if new inputs emerge.                                                            |
| 2025-10-22                                                                                                                                                                                          | ChatGPT (gpt-5-codex)                         | packages/engine/src/resourcesV2/types.ts; packages/engine/src/resourcesV2/index.ts; packages/engine/src/index.ts; packages/engine/tests/resourcesV2-types.test.ts; docs/project/resource-migration/production/production-living-docs.md                                                                                                                                                                                                                                                 | Added runtime ResourceV2 metadata catalog with conversion utilities covering ordering, parent mapping, percent formatting, and tier payload preservation, plus targeted engine tests.                                                               | `npm run check` (pass)                                                                                                                                                                                                | Coordinate engine effect handlers and UI consumers to adopt the runtime catalog in upcoming migration tasks.                                                                |
| 2025-10-23                                                                                                                                                                                          | ChatGPT (gpt-5-codex)                         | packages/engine/src/state/index.ts; packages/engine/src/actions/context_clone.ts; packages/engine/src/setup/create_engine.ts; packages/engine/tests/state-resourceV2.test.ts; docs/project/resource-migration/production/production-living-docs.md                                                                                                                                                                                                                                      | Added ResourceV2 player state scaffolding (value maps, bound trackers, touched flags, recent gain logs), updated cloning/bootstrap helpers, and introduced regression coverage.                                                                     | `npm run test:coverage:engine` (pass; chunk `20f285†L1-L55`); `npm run check -- --filter engine` (fails: npm-run-all rejects `--filter`; chunk `190734†L1-L2`)                                                        | Ensure engine/session callers supply the ResourceV2 catalog, extend integration tests, and rerun full `npm run check` once workspace filters are supported.                 |
| 2025-10-24                                                                                                                                                                                          | ChatGPT (gpt-5-codex)                         | packages/engine/src/services/resourceV2_service.ts; packages/engine/src/services/resourceV2_parent_tracker.ts; packages/engine/src/services/resourceV2_math.ts; packages/engine/src/services/services.ts; packages/engine/src/services/tiered_resource_service.ts; packages/engine/src/services/win_condition_service.ts; packages/engine/src/services/index.ts; packages/engine/tests/resourceV2-service.test.ts; docs/project/resource-migration/production/production-living-docs.md | Introduced ResourceV2Service with parent aggregation helper and math utilities, routed tiered-resource and win-condition lookups through V2 metadata, and expanded service tests covering clamping, transfers, hook suppression, and parent totals. | `npm run check -- --filter engine` (fails: npm-run-all rejects `--filter`; chunk `a22881†L1-L2`); `npm run check` (pass; chunk `6c32d8†L1-L63`)                                                                       | Coordinate downstream consumers (tiered resource UI, win-condition flows, analytics) to adopt ResourceV2 metadata and validate live catalogs once additional content lands. |
| 2025-10-24                                                                                                                                                                                          | ChatGPT (gpt-5-codex)                         | packages/contents/dist; packages/protocol/dist; packages/engine/dist; packages/testing/dist; packages/server/dist (regenerated); docs/project/resource-migration/production/production-living-docs.md                                                                                                                                                                                                                                                                                   | Restored package declaration bundles, reran the full repository `npm run check`, and confirmed the ResourceV2 service suite stays green after the dist clean-up cycle.                                                                              | `npm run check` (pass; chunk `d82ef0†L1-L73`)                                                                                                                                                                         | Continue migrating downstream consumers to ResourceV2 metadata; no immediate blockers after dist regeneration.                                                              |
| 2025-10-24                                                                                                                                                                                          | ChatGPT (gpt-5-codex)                         | packages/engine/src/effects/resource_v2_add.ts; packages/engine/src/effects/resource_v2_remove.ts; packages/engine/src/effects/resource_v2_transfer.ts; packages/engine/src/effects/resource_v2_upper_bound_increase.ts; packages/engine/src/effects/resource_v2_targets.ts; packages/engine/src/effects/index.ts; packages/engine/tests/resourceV2-effects.test.ts; docs/project/resource-migration/production/production-living-docs.md                                               |
|                                                                                                                                                                                                     |
| Implemented ResourceV2 effect handlers delegating to `ResourceV2Service`, exported the modules, and added comprehensive unit coverage for rounding, suppression metadata, and multi-step transfers. | `npm run check` (pass; chunk `d0a6a3†L1-L75`) |
| Register the new handlers in the core registry, migrate content to call them, and extend coverage for additional reconciliation scenarios.                                                          |

| 2025-10-25
| ChatGPT (gpt-5-codex) | packages
/engine/src/effects/index.ts; packages/engine/src/effects/resource_add.ts; packages/engine/src/effects/resource_remove.ts; packages/engine/src/effects/resource_transfer.ts; packages/engine/tests/helpers.ts; packages/engine/tests/effects/resource-legacy-bridge.test.ts; docs/project/resource-migration/production/production-living-docs.md |

                                                                                | Bridged legacy resource add/remove/transfer handlers to ResourceV2 service, introduced shared recent-gain flush logic, updated test helpers, and added hybrid regression coverage plus documentation. | `npx vitest run packages/engine/tests/effects/resource-legacy-bridge.test.ts` (pass; chunk `d075fc†L1-L27`); `npm run check -- --filter engine` (fails: npm-run-all rejects `--filter`; chunk `cff087†L1-L5`) |
                              | Re-run full `npm run check` / `npm run test` once the filter flag is fixed to reconfirm suite health post-bridge. |

| 2025-10-25
| ChatGPT (gpt-5-codex) | packages/engine/src/actions/costs.ts; packages/engine/src/setup/create_engine.ts; packages/engine/src/state/index.ts; packages/engine/tests/action-costs-resourceV2.test.ts; docs/project/resource-migration/production/production-living-docs.md

                                                                                | Enforced ResourceV2 global action cost metadata in engine state/action processing, routed engine context defaults through the catalog, and added regression coverage for overrides, system exemptions, and duplicate content. | `npm run check -- --filter engine` (fails: npm-run-all rejects `--filter`; chunk `4de5b2†L1-L5`); `npm run check` (pass; chunk `27f64f†L1-L169`) |
                              | Monitor future content updates to ensure exactly one ResourceV2 global cost resource and plan script support for targeted checks once `npm-run-all` gains filtering. |

| 2025-10-26 | ChatGPT (gpt-5-codex) | packages/protocol/src/session/index.ts; packages/protocol/src/session/contracts.ts; packages/protocol/src/config/session_contracts/shared.ts; packages/protocol/src/index.ts; packages/protocol/tests/session-snapshot-resourceV2.test.ts; docs/project/resource-migration/production/production-living-docs.md |

                                                                                | Extended protocol session snapshots with ResourceV2 state, ordering metadata, and optional registry group payloads plus regression coverage for mixed legacy/new serialization. | `npm run check -- --filter protocol` (fails: npm-run-all rejects `--filter`; chunk `d6c336†L1-L12`); `npx vitest run --config vitest.protocol.config.ts` (pass; chunk `2d9766†L1-L33`) |
                              | Align engine/server snapshot emitters to populate the new ResourceV2 fields end-to-end and update web selectors once transports supply the richer payloads. |

| 2025-10-27 | ChatGPT (gpt-5-codex) | packages/protocol/src/session/contracts.ts; packages/protocol/src/config/session_contracts/shared.ts; packages/server/src/session/SessionManager.ts; packages/server/src/session/sessionConfigAssets.ts; packages/server/src/session/registryUtils.ts; packages/server/tests/session-registry-resourceV2.test.ts |

                                                                                | Added ResourceV2 definition/group cloning for session registries, exposed the payload in server responses, and documented the migration status with new regression coverage. | `npm run format`; `npm run lint`; `npm run check -- --filter server` (fails: npm-run-all rejects `--filter`; chunk `fcc0f2†L1-L2`) |
                              | Coordinate with web/session consumers to hydrate against the new ResourceV2 registries and ensure engine snapshots reuse the server catalog to avoid divergence. |

| 2025-10-28 | ChatGPT (gpt-5-codex) | packages/server/src/session/buildSessionMetadata.ts; packages/server/src/session/resourceMetadataBuilders.ts; packages/server/src/session/SessionManager.ts; packages/server/src/session/sessionConfigAssets.ts; packages/protocol/src/session/index.ts; packages/protocol/src/session/contracts.ts; packages/protocol/src/config/session_contracts/shared.ts; packages/server/tests/session-metadata-resourceV2.test.ts; docs/project/resource-migration/production/production-living-docs.md |
| | Derived ResourceV2 descriptors, ordering, and parent/group metadata from registries via new helpers, updated session payload wiring, and added regression coverage for cloning and duplication guards. | `npm run format`; `npm run lint`; `npm run check` (pass; chunk `c213cb†L1-L12`) |
| | Coordinate downstream API consumers to adopt `resourceMetadata`/`resourceGroups` lookups and monitor web hydration performance once richer payloads land. |

| 2025-10-29 | ChatGPT (gpt-5-codex) | packages/protocol/src/config/session*contracts/shared.ts; packages/protocol/src/session/contracts.ts; packages/server/src/session/SessionManager.ts; packages/server/tests/FastifySessionTransport.test.ts; packages/server/tests/SessionManager.test.ts; packages/server/tests/helpers/createSyntheticSessionManager.ts; packages/server/tests/session-runtime-config-resourceV2.test.ts; packages/web/src/startup/runtimeConfig.ts; packages/web/tests/startup/runtimeConfig.test.ts | Bundled ResourceV2 definitions and groups into runtime config responses, extended server cloning utilities to freeze the new registries, updated web normalization fallbacks, and added regression coverage for server/web payload handling. | `npm run check` (pass; chunk `1ecc78†L1-L110`) | Coordinate frontend consumers to hydrate ResourceV2 catalogs from runtime config and monitor downstream selectors for legacy fallback reliance. |
| 2025-10-30 | ChatGPT (gpt-5-codex) | packages/testing/src/factories/resourceV2.ts; packages/testing/src/factories/resourceV2Metadata.ts; packages/testing/src/factories/content.ts; packages/testing/tests/session-resourceV2-support.test.ts; packages/web/tests/helpers/sessionSnapshot.ts; packages/web/tests/helpers/sessionFixtures.ts; docs/project/resource-migration/production/production-living-docs.md | Refactored testing ResourceV2 builders to delegate session metadata generation to a shared helper, added regression coverage for default and custom ResourceV2 snapshots, and split web session snapshot utilities to reuse the metadata-aware helpers. | `npm run check` (pass; engine chunk `9c939f†L1-L173`, protocol chunk `839f57†L1-L78`, integration chunk `9aa947†L1-L28`, web chunk `5bc4ef†L1-L42`, server chunk `32c85d†L1-L29`) | Expand integration coverage around server/web ResourceV2 hydration (e.g., snapshot hydration and registry contexts) once downstream consumers are updated. |
| 2025-10-31 | ChatGPT (gpt-5-codex) | `packages/web/src/state/sessionRegistries.ts`; `packages/web/src/state/sessionStateStore.ts`; `packages/web/src/contexts/RegistryMetadataContext.tsx`; `packages/web/src/contexts/registryMetadataHooks.ts`; `packages/web/src/state/__tests__/sessionRegistries.resourceV2.test.tsx`; `docs/project/resource-migration/production/production-living-docs.md` | Wired ResourceV2 definitions/groups into web registries and metadata contexts, refreshed selectors/hooks for ordered keys and parent descriptors, and expanded tests for ResourceV2 normalization and memoization. | `npx tsc --build packages/protocol/tsconfig.json --force` (pass; chunk `2a804d†L1-L2`); `npm run check` (pass; chunk `cf46fe†L1-L66`) | Monitor UI components consuming legacy resource registries for follow-up refactors now that ResourceV2 selectors are available. |
| 2025-11-01 | ChatGPT (gpt-5-codex) | packages/web/src/contexts/RegistryMetadataContext.tsx; packages/web/src/contexts/registryMetadataHooks.ts; packages/web/src/contexts/registryMetadataLookups.ts; packages/web/src/contexts/registryMetadataResourceBuilders.ts; packages/web/src/contexts/**tests**/registryMetadataContext.resourceV2.test.tsx; docs/project/resource-migration/production/production-living-docs.md | Enhanced web registry metadata context to derive ResourceV2 descriptors with ordered groups and legacy fallbacks, exposed updated hooks, and added targeted Vitest coverage for ResourceV2 descriptor resolution. | `npm run check` (pass; chunk `1e7a6a†L1-L20`) | Coordinate downstream UI components (ResourceBar, overview tokens, passive displays) to consume the new descriptor selectors and retire legacy resource lookups. |
| 2025-11-02 | ChatGPT (gpt-5-codex) | packages/web/src/components/player/ResourceBar.tsx; packages/web/src/components/player/ResourceBar.display.ts; packages/web/src/components/player/ResourceBar.happiness.ts; packages/web/src/components/player/ResourceButton.tsx; packages/web/src/components/player/registryDisplays.ts; packages/web/src/components/player/**tests**/ResourceBar.resourceV2.test.tsx; packages/web/src/styles/layout.css; docs/project/resource-migration/production/production-living-docs.md | Refactored ResourceBar to render ResourceV2 groupings with parent hovercards, percent-aware formatting, and legacy fallbacks; added shared helpers/styles and ResourceV2-focused snapshot coverage. | `npm run check` (pass; chunk `e9e9cd†L1-L68`) | Verify overview/passive panels adopt the new grouping helpers and extend legacy-path regression coverage for ResourceBar consumers. |
| 2024-**-** | *(add entry)\_ | – | – | – | – |

Append new rows chronologically (most recent at the bottom). Include command outputs or references to terminal chunks when relevant.

## 4. Latest Handover (overwrite each task)

- **Prepared by:** ChatGPT (gpt-5-codex)
- **Timestamp (UTC):** 2025-11-02 20:45
- **Current Focus:** ResourceBar UI migration to ResourceV2 group ordering, parent hovercards, and percent formatting fallbacks
- **State Summary:** ResourceBar now derives grouped entries from ResourceV2 metadata, surfaces parent hovercards with child summaries, formats percent resources, and retains legacy fallbacks via new helper modules, styling, and targeted tests.
- **Next Suggested Tasks:**
  - Extend overview and passive displays to reuse the ResourceBar grouping helpers and document legacy-only behaviour with regression tests.
  - Audit ResourceButton consumers for percent formatting expectations and add integration coverage for mixed-sign deltas.
- **Blocking Issues / Risks:** `npm run check` remains lengthy (~80s web suite); monitor for future flakiness as more UI surfaces migrate.
- **Reminder:** Maintain legacy fallbacks until all UI components consume ResourceV2 metadata to avoid regressions during rollout.

## 5. Notes & Decisions Archive

Maintain a running list of important updates. Use subheadings with timestamps.

### 2024-**-** – Initial scaffolding

- Placeholder: replace with summary when real work starts.
- Recommended first migration target: **Absorption** (selected for its limited integrations and low risk while still covering stat-specific behaviours).

### 2024-**-** – MVP scope alignment

- MVP delivery is limited to clamp-based reconciliation, parented ResourceGroups, mandatory add/remove/transfer/upper-bound increase effects, percent modifiers, the hook-suppression escape hatch, a single global action cost resource, unified HUD/translations, and signed gain/loss logging (Option A). All other features stay on the backlog for later phases.
- Deferred items (value/bound breakdown capture, additional bound adjusters, Pass/Reject reconciliation, parentless groups, bound-decrease effects, comprehensive validators, tier-based shortfall replacement, extra global cost resources) are tracked in [Deferred (Post-MVP) Work](../pre-production/project-outline.md#5-deferred-post-mvp-work). Do not reintroduce these during daily task triage.
- Phase summaries must log both gains and losses in `recentResourceGains` (Option A) so stakeholders can audit negative swings without waiting for the backlog enhancements.

## 6. Intended Temporary Regressions

Track deliberate breakages created by migration steps so nobody “fixes” them prematurely.

| Description  | Introduced In | Expected Resolution | Status |
| ------------ | ------------- | ------------------- | ------ |
| _(none yet)_ | –             | –                   | –      |

## 7. Pending Follow-ups / TODO Tracker

Use this table for short-lived reminders that do not warrant their own ticket yet.

| Item         | Owner | Due / Trigger | Status |
| ------------ | ----- | ------------- | ------ |
| _(none yet)_ | –     | –             | –      |

## 8. Reference

- [Pre-production documentation](../pre-production/)
- [Agent instructions](./agent-instructions.md)

Keep this document clean, factual, and immediately useful. Remove placeholder text as sections begin to fill with real project information.
