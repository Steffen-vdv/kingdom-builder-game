# Resource Migration Project – Production Living Document

This document captures the evolving state of the Resource Migration initiative. Every agent **must** read the entire file before making changes. Task-level updates now live in dedicated Markdown files under [`./worklogs/`](./worklogs/) (see directory README for the required template); do **not** edit the shared Work Log table directly. Instead, create a new per-task file, reference it in your handover notes, and allow the designated aggregator to merge highlights back into the table.

## 1. Quick Context

- **Project Name:** Resource Migration (ResourceV2 unification)
- **Goal:** Replace legacy resource/stat/population systems with the unified ResourceV2 platform across engine, content, protocol, and web.
- **Current Phase:** Engine integration & enforcement – wiring runtime catalog data, global costs, and population flows into ResourceV2.

## 2. High-Level Status Snapshot

| Area         | Current State       | Owner | Notes                                                                                                                                              |
| ------------ | ------------------- | ----- | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| Engine       | In progress         | –     | Runtime catalog, player state/setup, global cost, and population handlers now run on ResourceV2 (T38–T43); coverage blocked by contents TypeError. |
| Content      | MVP scope complete  | –     | Catalog, start payloads, actions, passives, and phases emit ResourceV2 payloads end to end (T18–T36).                                              |
| Protocol/API | In progress         | –     | Start schemas and session surfaces expose ResourceV2 catalog snapshots and payload maps (T25, T38).                                                |
| Web UI       | Pending integration | –     | Waiting on session payload rollout before translators can replace legacy resource wiring.                                                          |
| Testing      | Blocked             | –     | `npm run check` still fails with `developmentTarget` TypeError; targeted suites pass individually.                                                 |

Update the table whenever a domain meaningfully changes. Keep comments concise and reference sections below for detail.

## 3. Work Log (append-only)

> ⚠️ Parallel contributors: keep this table stable. Add your notes to [`./worklogs/`](./worklogs/) and notify the aggregator via the Latest Handover section so they can roll the details forward without risking merge conflicts.

| Date       | Agent                 | Scope / Files                                                                                                                                                                                                                                                                      | Summary of Work                                                                                                                                                                                                                               | Tests & Results                                                                                            | Follow-up Actions                                                                                                                      |
| ---------- | --------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------- |
| 2025-10-22 | ChatGPT (gpt-5-codex) | packages/contents/src/resourceV2/types.ts, packages/contents/src/resourceV2/index.ts, docs/project/resource-migration/production/production-living-docs.md                                                                                                                         | Resource Migration MVP - P2 - T1 - Added ResourceV2 schema type scaffolding and documented follow-ups.                                                                                                                                        | _Not run (types only)_                                                                                     | Confirm schema assumptions for tier metadata and group parent scope.                                                                   |
| 2025-10-23 | ChatGPT (gpt-5-codex) | packages/contents/src/resourceV2/resourceBuilder.ts, packages/contents/src/resourceV2/index.ts, docs/project/resource-migration/production/production-living-docs.md                                                                                                               | Resource Migration MVP - P2 - T2 - Implemented chainable ResourceV2 builder with validation, exported API, and captured next steps for registry helpers.                                                                                      | _Not run (builder scaffolding)_                                                                            | Draft registry helper adapters to adopt the builder in upcoming tasks.                                                                 |
| 2025-10-24 | ChatGPT (gpt-5-codex) | packages/contents/src/resourceV2/groupBuilder.ts, packages/contents/src/resourceV2/registry.ts, packages/contents/src/resourceV2/index.ts, packages/contents/src/index.ts, docs/project/resource-migration/production/production-living-docs.md                                    | Resource Migration MVP - P2 - T3 - Added ResourceV2 group builder and registry helpers with duplicate validation, exported APIs, and documented rollout.                                                                                      | npm run format; npm run lint; npm run check                                                                | Coordinate adoption of registry helpers in content packages and plan first migrated resource entry.                                    |
| 2025-10-25 | ChatGPT (gpt-5-codex) | packages/protocol/src/resource-v2/types.ts, packages/protocol/src/resource-v2/index.ts, packages/protocol/src/index.ts, docs/project/resource-migration/production/production-living-docs.md                                                                                       | Resource Migration MVP - P2 - T12 - Added ResourceV2 protocol payload types and exported them for downstream consumers, keeping parity with runtime schema.                                                                                   | npm run format; npm run lint; npm run check                                                                | Extend session contracts to surface ResourceV2 registries and payload structures.                                                      |
| 2025-10-25 | ChatGPT (gpt-5-codex) | packages/contents/tests/resourceV2/resourceV2Builders.test.ts, docs/project/resource-migration/production/production-living-docs.md                                                                                                                                                | Resource Migration MVP - P2 - T4 - Added ResourceV2 builder and group registry tests covering happy paths, duplicate setters, bounds validation, and cost safeguards, then documented outstanding questions.                                  | npm run test --workspace @kingdom-builder/contents (pass; see chunk 55968c)                                | Audit bounds() helper interactions with pre-set limits and validate multi-resource global cost authoring scenarios.                    |
| 2025-10-25 | ChatGPT (gpt-5-codex) | packages/engine/src/resource-v2/types.ts, packages/engine/src/resource-v2/content-types.ts, packages/engine/src/resource-v2/fromContent.ts, packages/engine/src/resource-v2/index.ts, docs/project/resource-migration/production/production-living-docs.md                         | Resource Migration MVP - P2 - T5 - Added runtime ResourceV2 catalog types, converter with MVP validation/defaulting, and documented pending integration tasks.                                                                                | npm run format; npm run lint; npm run check                                                                | Wire runtime catalog into engine bootstrap, finish converter tests, and confirm check pipeline in follow-up tasks.                     |
| 2025-10-25 | ChatGPT (gpt-5-codex) | packages/testing/src/factories/resourceV2.ts, packages/testing/src/index.ts, docs/project/resource-migration/production/production-living-docs.md                                                                                                                                  | Resource Migration MVP - P2 - T14 - Introduced ResourceV2 testing factories wrapping builders with override support and registry materialisers, plus documentation updates.                                                                   | npm run format; npm run lint; npm run check                                                                | Integrate helpers into engine/protocol suites and expand coverage once first migrated resource lands.                                  |
| 2025-10-26 | ChatGPT (gpt-5-codex) | packages/protocol/src/session/contracts.ts, packages/protocol/src/session/index.ts, docs/project/resource-migration/production/production-living-docs.md                                                                                                                           | Resource Migration MVP - P2 - T13 - Added optional ResourceV2 session contract fields (registries, player valuesV2, metadata mirrors) and documented their placeholder status.                                                                | npm run format; npm run lint; npm run check (partial – aborted during web suite due to duration)           | Wire server/session transports to populate the new ResourceV2 fields and rerun full check once wiring lands.                           |
| 2025-10-26 | ChatGPT (gpt-5-codex) | packages/engine/src/state/index.ts, packages/engine/src/actions/context_clone.ts, docs/project/resource-migration/production/production-living-docs.md                                                                                                                             | Resource Migration MVP - P2 - T6 - Added PlayerState scaffolding for ResourceV2 values, bounds, tier tracking, and touched flags while keeping legacy Resource/Stat wiring intact, then updated cloning to preserve the new maps.             | npm run format; npm run lint; npm run check                                                                | Plan follow-up wiring to seed ResourceV2 maps from runtime registries and surface them in snapshots once live data hooks in.           |
| 2025-10-26 | ChatGPT (gpt-5-codex) | packages/engine/src/resource-v2/reconciliation.ts, packages/engine/src/resource-v2/index.ts, docs/project/resource-migration/production/production-living-docs.md                                                                                                                  | Resource Migration MVP - P2 - T8 - Added reconciliation utilities that compute static/percent deltas with configurable rounding, clamp against bounds, export shared types, and documented remaining wiring steps.                            | npm run format; npm run lint; npm run check                                                                | Wire helpers into resource effect handlers and author targeted rounding/clamp unit tests.                                              |
| 2025-10-26 | ChatGPT (gpt-5-codex) | packages/web/src/translation/resourceV2/formatters.ts, packages/web/src/translation/resourceV2/index.ts, packages/web/src/translation/index.ts, packages/web/tests/translation/resourceV2/formatters.test.ts, docs/project/resource-migration/production/production-living-docs.md | Resource Migration MVP - P2 - T15 - Added ResourceV2 translation helpers that turn metadata/value snapshots into summaries, hover sections, and Option A signed gain entries, exported them for reuse, and covered the pure logic with tests. | npm run format; npm run lint; npm run check                                                                | Wire helpers into the web UI once ResourceV2 values surface in session snapshots and log wiring begins.                                |
| 2025-10-27 | ChatGPT (gpt-5-codex) | packages/engine/tests/resource-v2/state-helpers.test.ts, packages/engine/tests/resource-v2/effects-handlers.test.ts, docs/project/resource-migration/production/production-living-docs.md                                                                                          | Resource Migration MVP - P2 - T11 - Authored ResourceV2 state helper and handler tests covering clamp rounding, tier tracking, touched/bound flags, signed logging, and transfer options using runtime catalogs from the new converters.      | npx vitest run --config vitest.engine.config.ts packages/engine/tests/resource-v2 (pass; see chunk be9f1f) | Backfill tier-transition coverage for mixed transfers and parent bound changes once runtime catalog wiring reaches the engine context. |

| 2025-10-27 | ChatGPT (gpt-5-codex) | packages/contents/src/resourceV2/definitions/stats.ts, packages/contents/src/resourceV2/definitions/population.ts, packages/contents/src/resourceV2/catalog.ts | Resource Migration MVP - P2 - T20–T22 - Authored stat and population ResourceV2 definitions plus shared catalog registries (see ./worklogs/T20-stat-defs.md, ./worklogs/T21-population-resources.md, ./worklogs/T22-resource-catalog.md). | _Not run – content definitions/catalog updates only_ | Thread registries into engine/bootstrap surfaces and confirm downstream consumers resolve ResourceV2 ids. |
| 2025-10-27 | ChatGPT (gpt-5-codex) | packages/contents/src/resources.ts, packages/contents/src/stats.ts, packages/contents/src/happinessHelpers.ts | Resource Migration MVP - P2 - T23–T24 - Bridged legacy exports onto ResourceV2 registries and aligned rules metadata (see ./worklogs/T23-legacy-bridge.md, ./worklogs/T24-rules-alignment.md). | _Not run – bridge/rules alignment pending engine adoption_ | Migrate remaining content helpers to ResourceV2 metadata and retire manual formatting overrides. |
| 2025-10-27 | ChatGPT (gpt-5-codex) | packages/protocol/src/config/schema.ts, packages/contents/src/config/builders/startConfig/playerStartBuilder.ts, packages/contents/src/game.ts | Resource Migration MVP - P2 - T25–T27 - Extended protocol schemas, start builders, and start payloads with ResourceV2 values/bounds (see ./worklogs/T25-protocol-start-schema.md, ./worklogs/T26-start-builder.md, ./worklogs/T27-start-values.md). | _Not run – schema/start payload scaffolding only_ | Wire the new start maps through engine/session transports and validate mirrored values once check pipeline stabilises. |
| 2025-10-28 | ChatGPT (gpt-5-codex) | packages/contents/src/resourceV2/effects/changeBuilder.ts, packages/contents/src/resourceV2/effects/transferBuilder.ts, packages/contents/src/config/builders/effectParams/resourceParams.ts | Resource Migration MVP - P2 - T28–T31 - Introduced ResourceV2 change/transfer builders and wrapped legacy parameter helpers around them (see ./worklogs/T28-effect-builder.md, ./worklogs/T29-transfer-bound-builders.md, ./worklogs/T30-effect-core.md, ./worklogs/T31-param-migration.md). | _Not run – ResourceV2 builder migrations awaiting engine adoption_ | Execute contents and engine suites once handlers consume the new payloads to validate reconciliation paths. |
| 2025-10-28 | ChatGPT (gpt-5-codex) | packages/contents/src/actions/basicActions.ts, packages/contents/src/actions/buildActions.ts, packages/contents/src/actions/hireActions.ts, packages/contents/src/buildings.ts | Resource Migration MVP - P2 - T32–T36 - Converted core actions, passives, and phase hooks to ResourceV2 payloads (see ./worklogs/T32-basic-actions.md, ./worklogs/T33-build-develop-actions.md, ./worklogs/T34-hire-actions.md, ./worklogs/T35-passive-content.md, ./worklogs/T36-population-phase.md). | npm run format; npm run lint; npm run check _(fails: known developmentTarget TypeError and missing dist artifacts during repository check)_ | Coordinate with engine handlers to consume the new payloads and unblock the failing repository check stage. |
| 2025-10-28 | ChatGPT (gpt-5-codex) | docs/project/resource-migration/production/production-living-docs.md | Resource Migration MVP - P2 - T37 - Aggregated content migration progress and outstanding engine questions (see ./worklogs/T37-content-aggregation.md). | _Not run – documentation aggregation only_ | Resolve listed engineering questions and update the living doc as decisions land. |
| 2025-10-29 | ChatGPT (gpt-5-codex) | packages/engine/src/setup/create*engine.ts, packages/engine/src/state/index.ts, packages/protocol/src/session/resourceCatalogV2.ts | Resource Migration MVP - P2 - T38–T40 - Wired the runtime catalog through engine bootstrap, player state proxies, and start overrides (see ./worklogs/T38-engine-bootstrap.md, ./worklogs/T39-playerstate.md, ./worklogs/T40-player-setup.md). | npm run format; npm run lint; npm run check *(fails: `developmentTarget` TypeError during engine coverage)_ | Stabilise `developmentTarget` helper and expand engine tests around the new ResourceV2 bootstrap path. |
| 2025-10-29 | ChatGPT (gpt-5-codex) | packages/engine/src/actions/costs.ts, packages/engine/src/effects/index.ts, packages/engine/src/effects/population_add.ts | Resource Migration MVP - P2 - T41–T43 - Enforced catalog-driven global costs, re-registered ResourceV2 handlers, and synced population effects (see ./worklogs/T41-global-cost.md, ./worklogs/T42-effect-registry.md, ./worklogs/T43-population-handlers.md). | npm run format; npm run lint; npm run check _(fails: `developmentTarget` TypeError during engine coverage)\_ | Remove legacy cost/population shims once `developmentTarget` regression is fixed and ResourceV2 payloads are fully enforced. |
Append new rows chronologically (most recent at the bottom). Include command outputs or references to terminal chunks when relevant.

## 4. Latest Handover (overwrite each task)

- **Prepared by:** ChatGPT (gpt-5-codex)
- **Timestamp (UTC):** 2025-10-31 04:25
- **Current Focus:** Resource Migration MVP - P2 - T48 - Engine cleanup of legacy resource accessors
- **State Summary:** Legacy engine paths (developer presets, logging/snapshots, triggers, and resource/population effects) now flow through ResourceV2 helpers instead of touching `player.resources`/`stats`/`population` directly. Resource mutations call `setResourceValue` when the runtime catalog is present, with fallbacks for pre-migration bootstraps. See [`./worklogs/T48-engine-cleanup.md`](./worklogs/T48-engine-cleanup.md) for task notes.
- **Next Suggested Tasks:**
  - Convert remaining engine services (e.g., win-condition and tier utilities) to consume ResourceV2 ids exclusively so downstream consumers no longer rely on legacy keys.
  - Audit effect registries for any lingering `player.population` writes, especially custom handlers introduced by content tasks, and queue follow-up cleanups.
  - Once the `developmentTarget` TypeError is cleared, rerun `npm run check` to confirm ResourceV2 setters integrate cleanly with repository-wide tests.
- **Blocking Issues / Risks:** `npm run check` remains blocked by `TypeError: (0 , developmentTarget) is not a function` in `packages/contents/src/happinessHelpers.ts`, preventing an end-to-end verification pass.
- **Reminder:** Keep per-task worklogs under `./worklogs/` up to date and flag downstream owners when new runtime data surfaces so adoption stays coordinated.

## 5. Notes & Decisions Archive

Maintain a running list of important updates. Use subheadings with timestamps.

### 2024-**-** – Initial scaffolding

- Placeholder: replace with summary when real work starts.
- Recommended first migration target: **Absorption** (selected for its limited integrations and low risk while still covering stat-specific behaviours).

### 2024-**-** – MVP scope alignment

- MVP delivery is limited to clamp-based reconciliation, parented ResourceGroups, mandatory add/remove/transfer/upper-bound increase effects, percent modifiers, the hook-suppression escape hatch, a single global action cost resource, unified HUD/translations, and signed gain/loss logging (Option A). All other features stay on the backlog for later phases.
- Deferred items (value/bound breakdown capture, additional bound adjusters, Pass/Reject reconciliation, parentless groups, bound-decrease effects, comprehensive validators, tier-based shortfall replacement, extra global cost resources) are tracked in [Deferred (Post-MVP) Work](../pre-production/project-outline.md#5-deferred-post-mvp-work). Do not reintroduce these during daily task triage.
- Phase summaries must log both gains and losses in `recentResourceGains` (Option A) so stakeholders can audit negative swings without waiting for the backlog enhancements.

## 6. Intended Temporary Regressions

Track deliberate breakages created by migration steps so nobody “fixes” them prematurely.

| Description  | Introduced In | Expected Resolution | Status |
| ------------ | ------------- | ------------------- | ------ |
| _(none yet)_ | –             | –                   | –      |

## 7. Pending Follow-ups / TODO Tracker

Use this table for short-lived reminders that do not warrant their own ticket yet.

| Item         | Owner | Due / Trigger | Status |
| ------------ | ----- | ------------- | ------ |
| _(none yet)_ | –     | –             | –      |

## 8. Reference

- [Pre-production documentation](../pre-production/)
- [Agent instructions](./agent-instructions.md)

Keep this document clean, factual, and immediately useful. Remove placeholder text as sections begin to fill with real project information.
