# Domain Migration - T11-2-2-1 - Content metadata consumer inventory

## Scope and approach

- Source review combined the existing [registry consumer audit](./registry-consumers.md) with a repository-wide scan for `@kingdom-builder/contents` imports.
- Findings cover every runtime module (web client and server) and every colocated test file that reaches directly into content registries for icons, labels, descriptions, or structural metadata.
- Each entry below lists the metadata expectations, current fallbacks, and migration notes. Shared patterns that should migrate into reusable selectors or helpers are called out per area.

## Runtime modules

### Web overview surfaces

- **`packages/web/src/Overview.tsx`** – Pulls `OVERVIEW_CONTENT` hero copy, tokens, and section templates. Assumes hero tokens exist and merges runtime overrides via `createOverviewSections`; missing token icons render as empty placeholders but textual tokens remain highlighted. Migration should expose a selector for "overview hero content" that guarantees hero token completeness and exposes a consistent override hook.【F:packages/web/src/Overview.tsx†L1-L86】
- **`packages/web/src/components/overview/sectionsData.ts`** – Merges content-supplied token candidates with overrides and resolves icons into `OverviewSectionDef`. Missing icons fall back to `null`. Consolidate token merging logic into a selector so future providers only emit normalized candidate arrays.【F:packages/web/src/components/overview/sectionsData.ts†L1-L77】
- **`packages/web/src/components/overview/overviewTokenUtils.ts`** – Reads from `ACTIONS`, `PHASES`, `RESOURCES`, `STATS`, `POPULATION_ROLES`, plus static `LAND_INFO`/`SLOT_INFO`. Treats registries as exhaustive when building default token candidates and resolves icons with repeated `record[key]?.icon` lookups. Recommend extracting reusable selectors: `selectActionIcon(id)`, `selectPhaseIcon(id)`, and a generic `selectIcon(record, id)` helper to eliminate bespoke fallback logic.【F:packages/web/src/components/overview/overviewTokenUtils.ts†L1-L204】

### Player panel surfaces

- **`packages/web/src/components/player/PopulationInfo.tsx`** – Expects `POPULATION_ROLES`, `POPULATION_INFO`, `POPULATION_ARCHETYPE_INFO`, and `STATS` to provide icons, labels, and descriptions for hover cards and forecast badges. Lacking metadata leaves cards blank or falls back to raw ids. Centralized selectors like `selectPopulationRoleDisplay(id)` and `selectStatDisplay(id)` would avoid direct registry access throughout the component.【F:packages/web/src/components/player/PopulationInfo.tsx†L1-L165】
- **`packages/web/src/components/player/ResourceBar.tsx`** – Treats `Object.keys(RESOURCES)` as authoritative ordering, uses `RESOURCES[happinessKey]` for tier previews, and renders hover cards directly from registry metadata. Missing icons/descriptions lead to sparse tooltips. Introduce `selectResourceDisplay(key)` and `selectTieredResourceConfig()` selectors so UI code no longer manipulates registries directly.【F:packages/web/src/components/player/ResourceBar.tsx†L1-L178】
- **`packages/web/src/components/player/ResourceButton.tsx`** – Uses `RESOURCES[resourceKey]` for icon/label per button with no fallback. Should consume the same `selectResourceDisplay` helper as `ResourceBar` to keep accessibility text consistent.【F:packages/web/src/components/player/ResourceButton.tsx†L1-L65】
- **`packages/web/src/components/player/LandDisplay.tsx`** – Combines `LAND_INFO`, `SLOT_INFO`, `DEVELOPMENTS_INFO`, and translated development entries from runtime registries. Unknown development ids fall back to raw ids and empty icons. A helper such as `selectLandTileDisplay(landId)` that bundles land, slot, and development metadata would prevent UI-specific merges.【F:packages/web/src/components/player/LandDisplay.tsx†L1-L164】
- **`packages/web/src/components/player/PassiveDisplay.tsx`** – Relies on `PhaseId.Upkeep` to label upkeep timing and on `translationContext.assets.passive` for default icons. Builds tier previews by combining `PASSIVE_INFO`-style assets with tier definitions from contents. Suggest exposing selectors for passive presentation (icon, label, removal text) and for tier-definition lookups keyed by passive id.【F:packages/web/src/components/player/PassiveDisplay.tsx†L1-L156】
- **`packages/web/src/components/player/buildTierEntries.ts`** – Resolves `PASSIVE_INFO.icon`, `RESOURCES[tieredResourceKey].icon`, effect summaries, and text fallbacks (`'No effect'`). Duplicates slug parsing logic to humanize ids. Extract a selector that converts tier definitions into display-ready summaries, including icon fallbacks and default text, to share across Passive and Resource panels.【F:packages/web/src/components/player/buildTierEntries.ts†L1-L175】

### Action selection surfaces

- **`packages/web/src/components/actions/ActionsPanel.tsx`** – Casts content `focus` strings to the `Focus` union, depends on `RESOURCES[actionCostResource].icon` for header labels, and builds summary maps via `describeContent`/`summarizeContent`. A selector like `selectActionListForPlayer(playerId)` could return focus-safe DTOs (id, focus enum, icon, summary) so the panel avoids manual casting.【F:packages/web/src/components/actions/ActionsPanel.tsx†L1-L141】
- **`packages/web/src/components/actions/ActionCard.tsx`** – Accepts `Focus` to pick gradients, but otherwise delegates rendering. Ensure the proposed selectors normalize `focus` onto allowed ids so gradient lookups stay safe.【F:packages/web/src/components/actions/ActionCard.tsx†L1-L83】
- **`packages/web/src/components/actions/GenericActionCard.tsx`** – Reads `ResourceKey` typed action costs and resolves `translationContext.actions.get(id)` for icon/focus metadata. Missing registry entries degrade hover cards. Provide `selectActionDisplay(id)` returning icon/name/focus plus translated hover summary to centralize the repeated `record?.icon || key` pattern.【F:packages/web/src/components/actions/GenericActionCard.tsx†L1-L122】
- **`packages/web/src/components/actions/RaisePopOptions.tsx`** – Pulls `POPULATION_ROLES` for icon/label and `POPULATIONS` for detailed definitions. Try/catch guards missing registry rows but results become blank. A `selectPopulationRoleOptions(actionId)` helper should merge role metadata, requirement icons, and upkeep strings so the component simply renders UI.【F:packages/web/src/components/actions/RaisePopOptions.tsx†L1-L142】
- **`packages/web/src/components/actions/populationHelpers.ts`** – Centralizes much of the raise-pop metadata gathering but still imports `POPULATION_ROLES` and `POPULATION_INFO` directly. When migrating, keep this logic as a domain selector module instead of React helper to avoid UI coupling.【F:packages/web/src/components/actions/populationHelpers.ts†L1-L164】
- **`packages/web/src/components/actions/DevelopOptions.tsx`** – Uses `SLOT_INFO` for requirement icons and `describeContent` for development hover cards. A `selectDevelopmentOptions()` selector could deliver per-development requirements, icons, and summaries, while exposing slot icons via a shared lookup instead of hard-coding `SLOT_INFO` here.【F:packages/web/src/components/actions/DevelopOptions.tsx†L1-L142】
- **`packages/web/src/components/actions/DemolishOptions.tsx`** – Casts building focus metadata from registries and builds hover cards via `describeContent`. Reuse the proposed `selectBuildingDisplay(id)` helper to unify icon/focus extraction and error handling.【F:packages/web/src/components/actions/DemolishOptions.tsx†L1-L150】
- **`packages/web/src/components/actions/utils.ts`** – Implements `isResourceKey` and formatted missing-resource strings by peeking into `RESOURCES`. Move this into a shared selector (`selectResourceCostLabel(resourceKey, amount)`) to stop replicating lookups.【F:packages/web/src/components/actions/utils.ts†L1-L48】
- **`packages/web/src/components/actions/focusGradients.ts`** and **`types.ts`** – Type-only imports tie UI to the content-defined `Focus` union. Enforce focus normalization within selectors so React files stay type-checked without referencing contents directly.【F:packages/web/src/components/actions/focusGradients.ts†L1-L21】【F:packages/web/src/components/actions/types.ts†L1-L27】

### Game overlays and startup

- **`packages/web/src/components/game/GameConclusionOverlay.tsx`** – Treats `display.icon` as a resource key before falling back to literal strings. Provide a `selectWinConditionDisplay(id)` selector that resolves icons/labels with safe fallbacks so UI can stay declarative.【F:packages/web/src/components/game/GameConclusionOverlay.tsx†L1-L45】
- **`packages/web/src/main.tsx`** and **`packages/web/src/startup/resolvePrimaryIcon.ts`** – Resolve the game favicon by reading `PRIMARY_ICON_ID` and `RESOURCES`. Already includes fallback to the first resource with an icon; this logic should live in a selector returning `{ emoji, source }` rather than raw registry access in the entrypoint.【F:packages/web/src/main.tsx†L1-L33】【F:packages/web/src/startup/resolvePrimaryIcon.ts†L1-L20】

### Translation and utility modules

- **`packages/web/src/translation/render.tsx`** – Uses `RESOURCES` for cost icons and `BROOM_ICON` for upkeep, with per-call `RESOURCES[key]?.icon` fallbacks. Should rely on a formatting helper that already resolves resource icon/label pairs.【F:packages/web/src/translation/render.tsx†L1-L58】
- **Content translators (`packages/web/src/translation/content/*.ts`)** – `development.ts` illustrates reliance on `PHASES` metadata to gather per-phase effects. Similar files (tier, population, land) all look up icons/names directly from registries. Consolidate into selectors that expose translation-ready DTOs (icon, label, summary) keyed by content id so translators do not traverse registries manually.【F:packages/web/src/translation/content/development.ts†L1-L115】
- **Effect formatters (`packages/web/src/translation/effects/**/\*.ts`)** – Multiple modules (e.g., `resource.ts`, `population.ts`, `stat/index.ts`, attack formatters) repeatedly perform `RESOURCES[key]?.icon || key`fallbacks. Create dedicated lookup helpers such as`resolveResourceToken(key)`and`resolveStatToken(key)` to de-duplicate icon/label handling and guarantee safe fallbacks.【F:packages/web/src/translation/effects/formatters/resource.ts†L1-L40】
- **`packages/web/src/translation/effects/helpers.ts` & related** – Provide grammar helpers that depend on registry icons. Moving registry access into selectors keeps helper functions focused on string assembly.【F:packages/web/src/translation/effects/helpers.ts†L1-L80】
- **`packages/web/src/translation/requirements/translateRequirementFailure.ts`** – Maps requirement failure payloads to readable strings using `PopulationRole` and `Stat` enums. Centralize evaluator-to-icon translations in a selector used by both runtime and tests.【F:packages/web/src/translation/requirements/translateRequirementFailure.ts†L1-L120】
- **`packages/web/src/passives/visibility.ts`**, **`packages/web/src/utils/stats/*.ts`**, and **`packages/web/src/utils/getRequirementIcons.ts`** – All read registry metadata (`POPULATION_ROLES`, `RESOURCES`, `STATS`, `PASSIVE_INFO`, `TRIGGER_INFO`) to build descriptor maps. A shared selector module should expose `selectStatDescriptor(id)`, `selectTriggerDescriptor(id)`, and `selectRequirementIconSet(...)` to eliminate bespoke fallbacks (current behavior often returns empty arrays on missing metadata).【F:packages/web/src/utils/getRequirementIcons.ts†L1-L40】【F:packages/web/src/utils/stats/descriptorRegistry.ts†L1-L80】

### Web state & session scaffolding

- **`packages/web/src/state/developerModeSetup.ts`** – Instantiates registries via `createDevelopmentRegistry()` and enumerates ids to seed developer presets. Migration should expose developer presets from the content domain (e.g., `selectDeveloperPreset()`) rather than constructing from raw registries.【F:packages/web/src/state/developerModeSetup.ts†L1-L53】
- **`packages/web/src/state/sessionSdk.ts`** – Bootstraps engine sessions using `PHASES`, `GAME_START`, `RULES`, and `BuildingId`. Also extracts resource keys from registries. Wrap this bootstrapping inside a session service that consumes content selectors instead of static imports, keeping the SDK agnostic to content structure changes.【F:packages/web/src/state/sessionSdk.ts†L1-L126】
- **`packages/web/src/state/useActionPerformer.ts`** – Accepts `ActionId` typed parameters and relies on registries inside translation context after performing actions. Ensure the proposed selectors feed `useActionPerformer` with normalized action descriptors so it does not reach back into raw registries for icons/focus metadata.【F:packages/web/src/state/useActionPerformer.ts†L1-L116】

### Server runtime

- **`packages/server/src/session/SessionManager.ts`** – Seeds engine sessions with content registries (`ACTIONS`, `BUILDINGS`, `DEVELOPMENTS`, `POPULATIONS`, `PHASES`, `GAME_START`, `RULES`, `RESOURCES`). Also clones registries to expose over the protocol. Migration requires a dedicated server-side selector (e.g., `buildSessionRegistries()`) that can swap in new providers without editing the session manager.【F:packages/server/src/session/SessionManager.ts†L1-L108】

## Test modules

All tests below import `@kingdom-builder/contents` directly. Migration should re-route them through fixtures/selectors to keep assertions aligned with evolving metadata.

- **`packages/web/src/startup/resolvePrimaryIcon.test.ts`** – Verifies favicon fallbacks by reading `RESOURCES` and `PRIMARY_ICON_ID`. Replace with selector-based lookup once the runtime entrypoint stops importing registries directly.【F:packages/web/src/startup/resolvePrimaryIcon.test.ts†L1-L17】
- **Translation and formatter tests**: `packages/web/tests/attack-diff-formatters.test.ts`, `army-attack-translation.*.test.ts`, `land-till-formatter.test.ts`, `modifier-percent-formatting.test.ts`, `describe-skip-event.test.ts`, `passive-duration-formatter.test.ts`, `generic-actions-effect-group.test.tsx`, `raiders-guild-translation.test.ts`, `translateRequirementFailure.test.ts`, `tier-summary-translation.test.ts`, `development-summary.test.ts`, `append-stat-changes.test.ts`, `log-source-icons.test.ts`, `passive-log-labels.test.ts`, `passive-visibility.test.ts`, `PhasePanel.test.tsx`, `HoverCard.test.tsx`, and `Overview.test.tsx`. These files use `RESOURCES`, `STATS`, `PHASES`, `POPULATIONS`, `TIER_SUMMARY_STORE`, etc., to build expectations. Provide factory helpers (e.g., `createAttackDiffFixture()`, `selectPhaseList()`) that wrap registry access so assertions stay declarative.【F:packages/web/tests/attack-diff-formatters.test.ts†L1-L36】【F:packages/web/tests/passive-log-labels.test.ts†L1-L76】
- **Session and action helper tests**: Fixtures under `packages/web/tests/helpers` and suites like `ActionsPanel.test.tsx`, `resource-bar.test.tsx`, and `playerPanelFixtures.ts` rely on direct registry reads for icons, labels, and ids. Replace these with synthetic content factories (mirroring runtime selectors) to minimize coupling.【F:packages/web/tests/helpers/actionsPanel.ts†L1-L60】【F:packages/web/tests/ActionsPanel.test.tsx†L15-L42】
- **Server test helpers**: `packages/server/tests/helpers/createSyntheticSessionManager.ts` and related builder utilities create synthetic registries through content builders. When the server gains selector-based access, expose a `createTestSessionRegistries()` helper rather than constructing registries manually.【F:packages/server/tests/helpers/createSyntheticSessionManager.ts†L1-L32】

## Shared selector opportunities

| Theme                                | Current pattern                                                                              | Proposed selector/helper                                                                                                                      |
| ------------------------------------ | -------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------- |
| Resource display                     | `RESOURCES[key]?.icon`, `RESOURCES[key]?.label` scattered across UI, translators, and tests. | `selectResourceDisplay(key)` returning `{ icon, label, description, key }`, reused everywhere including cost formatting.                      |
| Stat & population descriptors        | Multiple modules read `STATS[statKey]`, `POPULATION_ROLES[role]`, falling back to ids.       | `selectStatDescriptor(id)`, `selectPopulationRoleDescriptor(id)` with guaranteed icon/label plus localization fallbacks.                      |
| Phase metadata                       | Overview tokens and passive displays loop through `PHASES`.                                  | `selectPhaseList()` returning structured `{ id, icon, label, steps }` and `selectPhaseIcon(id)` for quick lookup.                             |
| Tiered resource summaries            | `buildTierEntries` and passive panel duplicate tier-to-text mapping.                         | `selectTierSummaries(resourceKey, tiers)` to centralize slugging, icon selection, and "No effect" fallbacks.                                  |
| Action/building/development displays | Action panels manually merge focus, icons, summaries from registries.                        | `selectActionDisplay(id)`, `selectBuildingDisplay(id)`, `selectDevelopmentDisplay(id)` delivering icon, focus, summaries, and hover payloads. |
| Requirement icon resolution          | `getRequirementIcons`, `populationHelpers`, and tests all implement evaluator icon logic.    | `selectRequirementIcons(requirements, context)` returning a normalized icon list with graceful fallbacks.                                     |
| Passive presentation                 | Passive display composes icons and tier data, tests look up `PASSIVE_INFO`.                  | `selectPassivePresentation(id)` providing icon, label, summary, removal text, and tier sections when applicable.                              |

## Next steps

1. Stand up a `@kingdom-builder/selectors` (or equivalent) package that exports the proposed helpers, consuming registries internally.
2. Refactor runtime surfaces to depend on selectors instead of raw content registries, starting with high-traffic components (`ResourceBar`, `ActionsPanel`, `PassiveDisplay`).
3. Update tests to import fixtures/selectors rather than the content package, ensuring assertions reference selector outputs.
4. Align the server `SessionManager` and web `sessionSdk` on a shared registry-loading abstraction to make content provider swaps seamless.
5. Document selector guarantees (e.g., required icon presence) so future content schema changes remain backwards compatible for the UI.
