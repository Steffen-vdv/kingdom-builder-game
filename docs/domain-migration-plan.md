# Domain Migration Plan

## Target Frontend/Backend Separation

- **Frontend (Web)** consumes published APIs exposed by the backend to render
  UI, orchestrate client-side state, and surface user interactions.
- **Backend (Engine, Server, Protocol)** owns authoritative game state
  transitions, business rules, and multiplayer/session coordination. All client
  requests must route through these layers via versioned APIs.
- **Content** remains a shared domain but is published as immutable packages or
  registries that both frontend and backend load through stable interfaces.
- Communication across the boundary happens strictly through HTTP/WebSocket
  endpoints or other serialized protocol messages; no direct file system reads
  or module imports may cross the boundary.

## Current High-Level Coupling Pain Points

- UI components reach into engine helpers directly, creating brittle import
  chains that bypass API contracts and force simultaneous changes across
  domains.
- Shared utility modules leak presentation concerns into backend calculations,
  complicating testing and deployment pipelines.
- Content definitions occasionally reference frontend formatting logic,
  preventing independent versioning and rollback.
- Protocol schemas change without coordinated documentation, leaving consumers
  to guess message payloads and degrading reliability.

## Current Couplings

| Module                                                           | Engine Imports                                                         | Contents Imports                                                                                                                                                                                                        | Dependent Tests                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| ---------------------------------------------------------------- | ---------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `src/Overview.tsx`                                               | —                                                                      | `OVERVIEW_CONTENT`<br>`OverviewTokenCandidates`                                                                                                                                                                         | `tests/Overview.test.tsx`<br>`tests/overview-content-source.test.tsx`                                                                                                                                                                                                                                                                                                                                                                           |
| `src/components/actions/GenericActionCard.tsx`                   | `ActionEffectGroup`<br>`ActionEffectGroupOption`                       | —                                                                                                                                                                                                                       | —                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `src/components/actions/RaisePopOptions.tsx`                     | —                                                                      | `PopulationRoleId`                                                                                                                                                                                                      | `tests/components/actions/RaisePopOptions.test.tsx`                                                                                                                                                                                                                                                                                                                                                                                             |
| `src/components/actions/populationHelpers.ts`                    | —                                                                      | `PopulationRoleId`                                                                                                                                                                                                      | —                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `src/components/actions/useEffectGroupOptions.ts`                | `ActionEffectGroup`<br>`ActionEffectGroupOption`                       | —                                                                                                                                                                                                                       | —                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `src/components/overview/overviewTokenUtils.ts`                  | —                                                                      | `OverviewTokenCategoryName`                                                                                                                                                                                             | `tests/overview-tokens.test.tsx`                                                                                                                                                                                                                                                                                                                                                                                                                |
| `src/components/overview/sectionsData.ts`                        | —                                                                      | `OverviewSectionTemplate`<br>`OverviewTokenCandidates`<br>`OverviewTokenCategoryName`                                                                                                                                   | `tests/Overview.test.tsx`                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `src/components/player/BuildingDisplay.tsx`                      | `PlayerStateSnapshot`                                                  | —                                                                                                                                                                                                                       | —                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `src/components/player/LandDisplay.tsx`                          | `PlayerStateSnapshot`                                                  | —                                                                                                                                                                                                                       | —                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `src/components/player/PassiveDisplay.tsx`                       | `EffectDef`<br>`PassiveSummary`<br>`PlayerId`<br>`PlayerStateSnapshot` | `PhaseId`                                                                                                                                                                                                               | `tests/passive-display.test.tsx`                                                                                                                                                                                                                                                                                                                                                                                                                |
| `src/components/player/PlayerPanel.tsx`                          | `PlayerStateSnapshot`                                                  | —                                                                                                                                                                                                                       | `tests/PlayerPanel.test.tsx`                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `src/components/player/PopulationInfo.tsx`                       | `PlayerStateSnapshot`                                                  | `Stat`                                                                                                                                                                                                                  | `tests/PopulationInfo.test.tsx`                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `src/components/player/ResourceBar.tsx`                          | `PlayerStateSnapshot`                                                  | —                                                                                                                                                                                                                       | `tests/resource-bar.test.tsx`                                                                                                                                                                                                                                                                                                                                                                                                                   |
| `src/components/player/buildTierEntries.ts`                      | `RuleSnapshot`                                                         | —                                                                                                                                                                                                                       | `tests/passive-display.test.tsx`<br>`tests/resource-bar.test.tsx`                                                                                                                                                                                                                                                                                                                                                                               |
| `src/contexts/RegistryMetadataContext.tsx`                       | —                                                                      | `OVERVIEW_CONTENT`<br>`OverviewContentTemplate`                                                                                                                                                                         | `tests/ActionsPanel.test.tsx`<br>`tests/Overview.test.tsx`<br>`tests/PlayerPanel.test.tsx`<br>`tests/PopulationInfo.test.tsx`<br>`tests/components/actions/RaisePopOptions.test.tsx`<br>`tests/contexts/registryMetadataContext.test.tsx`<br>`tests/generic-actions-effect-group.test.tsx`<br>`tests/overview-content-source.test.tsx`<br>`tests/overview-tokens.test.tsx`<br>`tests/passive-display.test.tsx`<br>`tests/resource-bar.test.tsx` |
| `src/contexts/defaultRegistryMetadata.ts`                        | —                                                                      | `createActionRegistry`<br>`createBuildingRegistry`<br>`createDevelopmentRegistry`<br>`createPopulationRegistry`<br>`LAND_INFO`<br>`PASSIVE_INFO`<br>`PHASES`<br>`RESOURCES`<br>`SLOT_INFO`<br>`STATS`<br>`TRIGGER_INFO` | —                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `src/passives/visibility.ts`                                     | `PassiveSummary`                                                       | `POPULATIONS`                                                                                                                                                                                                           | `tests/passive-visibility.test.ts`                                                                                                                                                                                                                                                                                                                                                                                                              |
| `src/state/developerModeSetup.ts`                                | `EngineSession`<br>`PlayerId`                                          | —                                                                                                                                                                                                                       | —                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `src/state/formatPhaseResolution.ts`                             | —                                                                      | —                                                                                                                                                                                                                       | `tests/HoverCard.test.tsx`<br>`tests/state/formatPhaseResolution.integration.test.ts`<br>`tests/state/formatPhaseResolution.test.ts`<br><sub>Protocol-compliant (`SessionAdvanceResult`)</sub>                                                                                                                                                                                                                                                  |
| `src/state/sessionSdk.ts`                                        | `ActionParametersPayload`<br>`createEngineSession`<br>`EngineSession`  | —                                                                                                                                                                                                                       | `tests/state/GameProvider.test.tsx`<br>`tests/state/sessionSdk.test.ts`<br>`tests/state/useActionPerformer.test.ts`<br>`tests/state/useAiRunner.test.ts`<br>`tests/state/usePhaseProgress.helpers.test.ts`<br>`tests/state/usePhaseProgress.test.ts`                                                                                                                                                                                            |
| `src/state/sessionSelectors.types.ts`                            | `PlayerStateSnapshot`                                                  | —                                                                                                                                                                                                                       | —                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `src/state/useActionResolution.ts`                               | `PlayerStateSnapshot`                                                  | —                                                                                                                                                                                                                       | `tests/HoverCard.test.tsx`<br>`tests/ResolutionCard.test.tsx`<br>`tests/state/GameProvider.test.tsx`<br>`tests/state/useActionResolution.test.ts`                                                                                                                                                                                                                                                                                               |
| `src/state/useAiRunner.ts`                                       | `ActionParametersPayload`                                              | —                                                                                                                                                                                                                       | `tests/state/GameProvider.test.tsx`<br>`tests/state/useAiRunner.test.ts`                                                                                                                                                                                                                                                                                                                                                                        |
| `src/state/useNextTurnForecast.ts`                               | `PlayerSnapshotDeltaBucket`                                            | —                                                                                                                                                                                                                       | `tests/PlayerPanel.test.tsx`<br>`tests/PopulationInfo.test.tsx`<br>`tests/useNextTurnForecast.test.ts`                                                                                                                                                                                                                                                                                                                                          |
| `src/state/usePhaseProgress.helpers.ts`                          | `EngineAdvanceResult`                                                  | —                                                                                                                                                                                                                       | `tests/state/usePhaseProgress.helpers.test.ts`<br>`tests/state/usePhaseProgress.test.ts`                                                                                                                                                                                                                                                                                                                                                        |
| `src/translation/content/phased.ts`                              | —                                                                      | `TRIGGER_INFO`                                                                                                                                                                                                          | —                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `src/translation/content/population.ts`                          | —                                                                      | `PopulationRoleId`                                                                                                                                                                                                      | —                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `src/translation/context/assetSelectors.ts`                      | —                                                                      | `TRIGGER_INFO`                                                                                                                                                                                                          | `tests/attack-on-damage-registry.test.ts`<br>`tests/development-summary.test.ts`<br>`tests/development-translation.test.ts`                                                                                                                                                                                                                                                                                                                     |
| `src/translation/context/assets.ts`                              | —                                                                      | `TRIGGER_INFO`                                                                                                                                                                                                          | `tests/helpers/playerPanelFixtures.ts`<br>`tests/helpers/translationAssets.ts`                                                                                                                                                                                                                                                                                                                                                                  |
| `src/translation/effects/evaluators/population.ts`               | —                                                                      | `PopulationRoleId`                                                                                                                                                                                                      | —                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `src/translation/effects/formatters/attack/registrySelectors.ts` | —                                                                      | `BUILDINGS`<br>`ResourceKey`<br>`RESOURCES`<br>`StatKey`<br>`STATS`                                                                                                                                                     | `tests/army-attack-translation.log.test.ts`<br>`tests/army-attack-translation.summary.test.ts`<br>`tests/attack-diff-formatters.test.ts`<br>`tests/helpers/armyAttackFactories.ts`<br>`tests/raiders-guild-translation.test.ts`                                                                                                                                                                                                                 |
| `src/translation/effects/formatters/attack/resource.ts`          | —                                                                      | `Resource`<br>`ResourceKey`                                                                                                                                                                                             | —                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `src/translation/effects/formatters/attack/stat.ts`              | —                                                                      | `StatKey`                                                                                                                                                                                                               | —                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `src/translation/effects/formatters/attack/statContext.ts`       | —                                                                      | `Stat`<br>`StatKey`                                                                                                                                                                                                     | —                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `src/translation/effects/formatters/attack/types.ts`             | —                                                                      | `ResourceKey`<br>`StatKey`                                                                                                                                                                                              | —                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `src/translation/effects/formatters/attack.ts`                   | —                                                                      | `ResourceKey`                                                                                                                                                                                                           | `tests/army-attack-translation.log.test.ts`<br>`tests/army-attack-translation.summary.test.ts`<br>`tests/attack-diff-formatters.test.ts`<br>`tests/attack-on-damage-registry.test.ts`<br>`tests/helpers/armyAttackFactories.ts`<br>`tests/raiders-guild-translation.test.ts`                                                                                                                                                                    |
| `src/translation/effects/formatters/attackFormatterUtils.ts`     | —                                                                      | `ResourceKey`                                                                                                                                                                                                           | `tests/attack-on-damage-registry.test.ts`                                                                                                                                                                                                                                                                                                                                                                                                       |
| `src/translation/effects/formatters/land.ts`                     | —                                                                      | `LAND_INFO`<br>`SLOT_INFO`                                                                                                                                                                                              | —                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `src/translation/effects/formatters/modifier.ts`                 | —                                                                      | `RESOURCE_TRANSFER_ICON`                                                                                                                                                                                                | `tests/hold-festival-action-translation.test.ts`<br>`tests/modifier-eval-handlers.test.ts`<br>`tests/raiders-guild-translation.test.ts`                                                                                                                                                                                                                                                                                                         |
| `src/translation/effects/formatters/modifier_helpers.ts`         | —                                                                      | `DevelopmentDef`                                                                                                                                                                                                        | `tests/hold-festival-action-translation.test.ts`<br>`tests/raiders-guild-translation.test.ts`                                                                                                                                                                                                                                                                                                                                                   |
| `src/translation/effects/formatters/modifier_targets.ts`         | —                                                                      | `ActionDef`                                                                                                                                                                                                             | —                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `src/translation/effects/formatters/population.ts`               | —                                                                      | `PopulationRoleId`                                                                                                                                                                                                      | —                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `src/translation/effects/helpers.ts`                             | —                                                                      | `PopulationRoleId`                                                                                                                                                                                                      | `tests/raiders-guild-translation.test.ts`                                                                                                                                                                                                                                                                                                                                                                                                       |
| `src/translation/effects/registrySelectors.ts`                   | —                                                                      | `PopulationRoleId`<br>`StatKey`<br>`STATS`                                                                                                                                                                              | `tests/append-stat-changes.test.ts`<br>`tests/log-source-icons.test.ts`<br>`tests/modifier-eval-handlers.test.ts`<br>`tests/passive-log-labels.test.ts`                                                                                                                                                                                                                                                                                         |
| `src/utils/describeSkipEvent.ts`                                 | `AdvanceSkip`                                                          | —                                                                                                                                                                                                                       | `tests/describe-skip-event.test.ts`<br>`tests/state/formatPhaseResolution.test.ts`                                                                                                                                                                                                                                                                                                                                                              |
| `src/utils/getRequirementIcons.ts`                               | —                                                                      | `POPULATION_ROLES`<br>`PopulationRoleId`<br>`StatKey`<br>`STATS`                                                                                                                                                        | `tests/ActionsPanel.test.tsx`<br>`tests/generic-actions-effect-group.test.tsx`<br>`tests/getRequirementIcons.test.ts`                                                                                                                                                                                                                                                                                                                           |
| `src/utils/stats/dependencyFormatters.ts`                        | `PlayerStateSnapshot`<br>`StatSourceLink`<br>`StatSourceMeta`          | —                                                                                                                                                                                                                       | —                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `src/utils/stats/descriptorRegistry.ts`                          | —                                                                      | `PASSIVE_INFO`<br>`POPULATION_ROLES`<br>`RESOURCES`<br>`STATS`                                                                                                                                                          | `tests/attack-on-damage-registry.test.ts`<br>`tests/stat-breakdown.test.ts`<br>`tests/stat-descriptor-registry.test.ts`                                                                                                                                                                                                                                                                                                                         |
| `src/utils/stats/format.ts`                                      | —                                                                      | `STATS`                                                                                                                                                                                                                 | —                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `src/utils/stats/historyEntries.ts`                              | `StatSourceMeta`                                                       | —                                                                                                                                                                                                                       | —                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `src/utils/stats/passiveFormatting.ts`                           | `StatSourceLink`<br>`StatSourceMeta`                                   | `formatPassiveRemoval`<br>`PASSIVE_INFO`<br>`PhaseStepId`                                                                                                                                                               | —                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `src/utils/stats/summary.ts`                                     | `PlayerStateSnapshot`<br>`StatSourceMeta`                              | —                                                                                                                                                                                                                       | —                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `src/utils/stats/triggerLabels.ts`                               | —                                                                      | `TRIGGER_INFO`                                                                                                                                                                                                          | —                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `src/utils/stats/types.ts`                                       | `PlayerStateSnapshot`<br>`StatSourceLink`                              | —                                                                                                                                                                                                                       | —                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `src/utils/stats.ts`                                             | `PlayerStateSnapshot`<br>`StatKey`<br>`StatSourceContribution`         | `STATS`                                                                                                                                                                                                                 | `tests/PlayerPanel.test.tsx`<br>`tests/append-stat-changes.test.ts`<br>`tests/attack-on-damage-registry.test.ts`<br>`tests/modifier-percent-formatting.test.ts`<br>`tests/stat-breakdown.test.ts`<br>`tests/stat-descriptor-registry.test.ts`                                                                                                                                                                                                   |

## API Gaps

- **2025-10-12** – Protocol now mirrors the Engine
  `simulateUpcomingPhases` payloads (`PlayerSnapshotDeltaBucket`,
  `SimulateUpcomingPhasesIds`, `SimulateUpcomingPhasesOptions`, and
  `SimulateUpcomingPhasesResult`). Web state hooks such as
  `useNextTurnForecast` can migrate to the protocol contracts to remove their
  direct Engine dependency once the consumer side is updated.

## Guiding Principles

1. **API-First Collaboration**: All cross-domain collaboration happens through
   documented APIs or protocol schemas. If functionality is needed across
   domains, expose it via an API rather than sharing internal modules.
2. **Immutable Contracts**: Version APIs, protocol schemas, and content
   registries so each domain can deploy independently. Breaking changes require
   migration notes in the handover log before rollout.
3. **Content Neutrality**: Treat content packages as data sources only.
   Business logic remains in Engine/Server, and presentation logic stays in Web.
   Content authors should not depend on runtime-specific behaviour.
4. **Separation of Concerns**: Enforce clear ownership boundaries. Web handles
   presentation and client orchestration; Engine processes rules; Server
   coordinates persistence and sessions; Protocol defines message contracts;
   Content supplies data.
5. **Observability and Documentation**: Every cross-domain touchpoint must
   include monitoring, tests, and reference docs so future iterations can verify
   compatibility quickly.

## Domain Responsibilities

- **Web**: Render UI, manage client-side state, compose content-driven visuals,
  and call backend APIs. Must never import Engine, Server, or Protocol
  implementation modules directly; relies solely on published API clients and
  generated protocol bindings.
- **Engine**: Implement deterministic game rules, simulations, and validation
  logic. Exposes functionality through backend services only and forbids
  importing Web or Content presentation helpers.
- **Content**: Provide structured, versioned data definitions for game entities,
  tuned to remain engine-agnostic. Content may define schemas but must not
  import Web, Engine, Protocol, or Server code.
- **Protocol**: Define serialized message schemas, transports, and version
  negotiation for communication between Web and Server. Protocol modules export
  generation artifacts (e.g., OpenAPI/Protobuf) but never import runtime logic
  from other domains.
- **Server**: Orchestrate sessions, persistence, and network endpoints. Imports
  Engine via stable service interfaces, loads Content via registries, and
  exposes Protocol-compliant APIs to Web. Must not import Web code or access
  Engine internals not exposed through its service contracts.

Cross-domain access is permitted only through explicit API clients, protocol
bindings, or content registry loaders. Direct cross-imports between these
domains are prohibited.

## Handover Log

Future contributors must record every migration step in this section whenever
they adjust domain boundaries or cross-domain touchpoints.

Each entry must include:

- **Date & Author**
- **Files Touched** (list every file and its domain)
- **Intent** (why the change was made and which principle it supports)
- **Communication Path Update** (describe new or altered API/protocol/content
  contracts)
- **Follow-Up Notes** (outstanding actions, monitoring, or documentation to
  complete)

Add new entries in reverse chronological order and ensure related tickets or
diagrams are linked where possible. Do not merge a change affecting domain
boundaries without updating this log.

<!-- Handover entries start below. Keep newest entries at the top. -->

- **Date & Author**: 2025-10-19 – ChatGPT (gpt-5-codex)
  - **Files Touched**:
    - `packages/web/src/contexts/defaultRegistryMetadata.ts` (Web)
    - `packages/web/src/contexts/defaultRegistryMetadata.json` (Web)
    - `scripts/generate-default-registry-metadata.ts` (Scripts)
    - `docs/domain-migration-plan.md` (Docs)
  - **Intent**: Snapshot registry metadata into a static JSON fallback so the
    Web domain can boot without importing metadata constants from the Content
    package.
  - **Communication Path Update**: Web now consumes
    `defaultRegistryMetadata.json` for snapshot metadata while continuing to
    create live registries via the published content factories.
  - **Follow-Up Notes**: When content updates require new metadata, run
    `npx --yes tsx scripts/generate-default-registry-metadata.ts` to refresh the
    JSON snapshot and commit the result alongside any associated changes.

- **Date & Author**: 2025-10-15 – ChatGPT (gpt-5-codex)
  - **Files Touched**:
    - `packages/web/src/passives/visibility.ts` (Web)
    - `packages/web/tests/passive-visibility.test.ts` (Web)
    - `docs/domain-migration-plan.md` (Docs)
  - **Intent**: Finish decoupling passive visibility helpers from Engine and
    Content by injecting population identifiers through caller-provided
    options/contexts rather than importing registries across domains.
  - **Communication Path Update**: Web components and tests now supply
    population role ids explicitly when constructing visibility contexts,
    allowing the helper to operate solely on snapshot data without touching
    Engine types or Content registries.
  - **Follow-Up Notes**: Audit any legacy call sites that may still rely on
    implicit population lists to ensure they forward the ids from protocol
    registries or snapshots when needed.

- **Date & Author**: 2025-10-14 – ChatGPT (gpt-5-codex)
  - **Files Touched**:
    - `packages/web/src/components/player/BuildingDisplay.tsx` (Web)
    - `packages/web/src/components/player/LandDisplay.tsx` (Web)
    - `packages/web/src/components/player/PopulationInfo.tsx` (Web)
    - `packages/web/src/components/player/ResourceBar.tsx` (Web)
    - `packages/web/src/components/player/PlayerPanel.tsx` (Web)
    - `docs/domain-migration-plan.md` (Docs)
  - **Intent**: Continue the player panel migration by replacing Engine snapshot
    dependencies with protocol session snapshots so the UI reads session state
    exclusively through the shared contracts.
  - **Communication Path Update**: Player overview components now import
    `SessionPlayerStateSnapshot` from `@kingdom-builder/protocol`, aligning
    their props and derived state with the protocol schema rather than Engine
    aliases.
  - **Follow-Up Notes**: `PassiveDisplay.tsx` and related tests still rely on
    Engine `PlayerStateSnapshot` helpers. Migrate them to the protocol schema
    to complete the player panel decoupling.

- **Date & Author**: 2025-10-13 – ChatGPT (gpt-5-codex)
  - **Files Touched**:
    - `packages/web/src/components/actions/GenericActionCard.tsx` (Web)
    - `packages/web/src/components/actions/useEffectGroupOptions.ts` (Web)
    - `docs/domain-migration-plan.md` (Docs)
  - **Intent**: Shift the actions UI to consume effect group contracts from the
    protocol package instead of the Engine to reinforce the domain migration
    boundaries.
  - **Communication Path Update**: Action effect group components now import
    `ActionEffectGroup` and `ActionEffectGroupOption` directly from
    `@kingdom-builder/protocol`, keeping option parameter helpers aligned with
    the shared schema.
  - **Follow-Up Notes**: The actions UI still depends on
    `useGameEngine()`/`GameEngineApi['session']` to fetch costs, requirements,
    and option groups (`GenericActions.tsx`, `types.ts`). Follow-up tasks should
    introduce protocol-backed session selectors so the UI can drop these Engine
    hooks entirely.
    - `packages/web/src/state/sessionSelectors.types.ts` (Web)
  - **Intent**: Shift session selector view models onto protocol player
    snapshots to continue removing direct Engine dependencies from the web
    state layer.
  - **Communication Path Update**: Web selectors now rely on
    `SessionPlayerStateSnapshot` sourced from the Protocol package, ensuring
    downstream consumers traverse the published session contracts instead of
    Engine aliases.
  - **Follow-Up Notes**: Audit remaining web utilities (`utils/stats/*`,
    player panel components, and related tests) that still import
    `PlayerStateSnapshot` from the Engine to complete the decoupling.

- **Date & Author**: 2025-10-12 – ChatGPT (gpt-5-codex)
  - **Files Touched**:
    - `packages/protocol/src/session/index.ts` (Protocol)
    - `packages/protocol/src/index.ts` (Protocol)
    - `packages/protocol/tests/simulate-upcoming-phases.test.ts` (Protocol)
    - `docs/domain-migration-plan.md` (Docs)
  - **Intent**: Expose simulate-upcoming-phases payload types through Protocol to
    uphold API-first collaboration and unblock Web from importing Engine
    internals.
  - **Communication Path Update**: Protocol now mirrors the Engine
    `simulateUpcomingPhases` result and delta bucket structures so Web can rely
    on published session contracts.
  - **Follow-Up Notes**: Coordinate with Web to switch
    `useNextTurnForecast` (and related tests) to the new protocol exports.
